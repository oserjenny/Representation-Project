---
title: "Data cleaning"
author: "Jenny"
date: "January 2019"
output:
  pdf_document: default
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(readr)
library(tidyverse)
library(knitr)
library(haven)
```

## Introduction

This file documents the data cleaning for the Representation Project

## Data cleaning - Cumulative

Read in the data.
```{r}
tbl<-read_rds("../Data/cumulative_2006_2017.Rds")
```

Take a look at the data
```{r} 
head(tbl)
```

Another way to look at the data, where we can clearly see all variable names and types.
```{r} 
tbl %>% glimpse()
```

Select variables (from Kuriwaki Guide)
```{r}
tbl %>%
  select(year, case_id, pid3)
```


Display frequencies of validated turnout General Election over time - shows only first few rows in console
```{r} 
tbl %>% 
  group_by(year) %>% 
  count(vv_turnout_gvm)
```

Display frequencies of validated turnout General Election over time - shows all rows in console in `kable` format to print in a clean formatted table.
```{r} 
tbl %>% 
  group_by(year) %>% 
  count(vv_turnout_gvm) %>% 
  kable()
```

Recode of vv_turnout_gvm to dichotomous
```{r} 
tbl <- tbl %>%
  mutate(vv_turnout_gvm_binary = as.numeric(vv_turnout_gvm == "Voted"))
```

Display frequencies of recoded Validated turnout General Election over time 
```{r} 
tbl %>% 
  group_by(year) %>% 
  count(vv_turnout_gvm_binary)
```

Display table, frequencies of recoded Validated turnout General Election over time 
```{r} 
tbl %>% 
  group_by(year) %>% 
  count(vv_turnout_gvm_binary) %>% 
  kable(align = c("l", "c", "c"))
```


## Descriptive Statistics

Year:
```{r} 
tbl %>% 
  count(year) 
```

tookpost - "Whether or not the respondent took the post-election wave of the survey (in even years)"
```{r} 
tbl %>% 
  group_by(year) %>% 
  count(tookpost) %>% 
  filter(!is.na(tookpost)) %>% 
  mutate(percent = round((n / sum(n)) * 100, 2))
```

Weight - year-specific for all years, see Kuriwaki p.7 for notes
```{r} 
tbl %>% 
  group_by(year) %>% 
  summarize(mean = mean(weight, na.rm = TRUE),
            sd   = sd(weight, na.rm = TRUE),
            min  = min(weight),
            max  = max(weight)
  )
```

Weight - cumulative. Includes simple adjustment of multiplying a constant within year to make years comparable.
```{r} 
tbl %>% 
  group_by(year) %>% 
  summarize(mean = mean(weight_cumulative, na.rm = TRUE),
            sd   = sd(weight_cumulative, na.rm = TRUE),
            min  = min(weight_cumulative),
            max  = max(weight_cumulative)
  )
```

Geographic variables
*state - imputed from input zipcode
*st - same data as "State", Var name = 2-letter State abbreviation
```{r} 
tbl %>% 
  count(state, st) 
```


Geographic variables
*cd: Congressional district in current Congress
```{r} 
tbl %>% 
  count(st, cd) 
```

Gender
```{r} 
tbl %>% 
  count(gender) 
```

Age
```{r} 
tbl %>% 
  summarize(mean = mean(age),
            sd   = sd(age),
            min  = min(age),
            max  = max(age)
  ) %>% 
  mutate(variable = "age") %>% 
  select(variable, everything())
```

## Figures

Plot turnout dichotomous by year via bar charts:

```{r} 

# counts
tbl %>% 
  filter(year %% 2 != 1) %>%        # filter to even years
  mutate(year = as.character(year)) %>% 
  ggplot(aes(x = year, y = vv_turnout_gvm_binary, colour = year)) +
  geom_bar(stat = "identity") +
  labs(x = "Year", y = "Voter Turnout", title = "Voter Turnout by Year") +
  theme(legend.position = "none")

# percent
tbl %>% 
  filter(year %% 2 != 1) %>%        # filter to even years
  mutate(year = as.character(year)) %>% 
  group_by(year) %>% 
  summarize(percent = mean(vv_turnout_gvm_binary, na.omit = TRUE) * 100) %>% 
  ggplot(aes(x = year, y = percent, fill = year)) +
  geom_bar(stat = "identity") +
  labs(x = "Year", y = "Percent Voter Turnout", title = "Percent Voter Turnout by Year") +
  theme(legend.position = "none")
```

Plot turnout dichotomous by year via line plots:

```{r}

# counts
tbl %>% 
  group_by(year) %>% 
  count(vv_turnout_gvm_binary) %>% 
  filter(vv_turnout_gvm_binary == 1) %>% 
  ggplot(aes(x = year, y = n)) +
  geom_line() +
  geom_point() +
  ylim(0, 50000) +
  labs(x = "Year", y = "Voter Turnout", title = "Voter Turnout by Year")

# percents
tbl %>% 
  filter(year %% 2 != 1) %>%        # filter to even years
  mutate(year = as.character(year)) %>% 
  group_by(year) %>% 
  summarize(percent = mean(vv_turnout_gvm_binary, na.omit = TRUE) * 100) %>% 
  ungroup() %>% 
  ggplot(aes(x = year, y = percent, group = 1)) +
  geom_point() +
  geom_line() +
  ylim(0, 100) +
  labs(x = "Year", y = "Percent Voter Turnout", title = "Percent Voter Turnout by Year")
```



## Data cleaning - 2012, replicating Perspectives findings with focus on Independents

JO dropbox link to Nov 2018 work on this topic in stata:
CCES 2012_Russ Sage: https://www.dropbox.com/sh/fc7cn2fmaxocsyu/AADt5fFQ9jFXUQgcW65pVYvRa?dl=0

Read in 2012 cleaned data for Perspectives paper.
```{r}

tbl2012 <- read_dta("../Data/CCES_foranalysis.dta")
```

Examine the variables we are interested in.

```{r}

tbl2012 %>% 
  select(healthcarerepeal1_House1,
         ryanbudget_House1,
         koreafreetrade_House1,
         simpsonbowles_House1,
         keystonepipeline_House1,
         dontaskdonttell_House1) %>% 
  glimpse()  
```

Some descriptive statistics.

```{r}

tbl2012_vars <- tbl2012 %>% 
  select(healthcarerepeal1_House1,
         ryanbudget_House1,
         koreafreetrade_House1,
         simpsonbowles_House1,
         keystonepipeline_House1,
         dontaskdonttell_House1) %>% 
  colnames()

tbl2012_vars %>% 
  map(~ tbl2012 %>%
        count(!!sym(.x)) %>%
        mutate(percent = round((n / sum(n)) * 100, 2)))

# counts of healthcare repeal votes in the House grouped by state district and party
tbl2012 %>% 
  group_by(st_dist, party_House1) %>% 
  count(healthcarerepeal1_House1)
```

These are pretty messy, let's recode them.
```{r}

tbl2012 <- tbl2012 %>% 
  mutate_at(tbl2012_vars, list(~ na_if(., y = ""))) %>% 
  mutate(
    healthcarerepeal1_House1 = case_when(
      healthcarerepeal1_House1 == "For"     ~ "For",
      healthcarerepeal1_House1 == "Against" ~ "Against",
      TRUE ~ NA_character_
    ),
    ryanbudget_House1 = case_when(
      ryanbudget_House1 == "For"     ~ "For",
      ryanbudget_House1 == "Against" ~ "Against",
      TRUE ~ NA_character_
    ),
    koreafreetrade_House1 = case_when(
      koreafreetrade_House1 == "For"     ~ "For",
      koreafreetrade_House1 == "Against" ~ "Against",
      TRUE ~ NA_character_
    ),
    simpsonbowles_House1 = case_when(
      simpsonbowles_House1 == "For"     ~ "For",
      simpsonbowles_House1 == "Against" ~ "Against",
      TRUE ~ NA_character_
    ),
    keystonepipeline_House1 = case_when(
      keystonepipeline_House1 == "For"     ~ "For",
      keystonepipeline_House1 == "Against" ~ "Against",
      TRUE ~ NA_character_
    ),
    dontaskdonttell_House1 = case_when(
      dontaskdonttell_House1 == "Announced For"     ~ "For",
      dontaskdonttell_House1 == "Announced Against" ~ "Against",
      dontaskdonttell_House1 == "Yea"     ~ "For",
      dontaskdonttell_House1 == "Nay" ~ "Against",
      TRUE ~ NA_character_
    )
  )

# check recodes
tbl2012_vars %>% 
  map(~ tbl2012 %>%
        count(!!sym(.x)) %>%
        mutate(percent = round((n / sum(n)) * 100, 2)))                                         
```  


## Data cleaning - Panel 2010-2012-2014

Link to prior panel data analyses in stata:
CCES panel 2010-2012-2014: https://www.dropbox.com/sh/gj4vfv9xzvdgkwd/AABpmEqKQBT6EQDVCFvqeV7Ka?dl=0

Read in the data.

```{r}

tbl_panel <- haven::read_dta("../Data/CCES_Panel_Full3waves_VV_V4.dta", encoding = "latin1")
```


I. Create joined data file (respondents & roll call votes)
In stata: Reshaped into wide format to join
In R, relevant commands: spread, gather, mutate_at

Link for CCES 2014 supplemental data:
https://dataverse.harvard.edu/dataset.xhtml?persistentId=doi:10.7910/DVN/D1N0GO 

Link for CCES 2012 supplemental data
https://dataverse.harvard.edu/dataset.xhtml?persistentId=doi:10.7910/DVN/NI3BDE 

Link for CCES 2010 supplemental data:
https://dataverse.harvard.edu/dataset.xhtml?persistentId=doi:10.7910/DVN/KC9EQR


Recode of relevant respondent measures
CC10_330A = 
Roll Call - American Recovery and Reinvestment Act
[According to PanelGuide downloaded 1Feb2019 - https://dataverse.harvard.edu/dataset.xhtml?persistentId=doi:10.7910/DVN/TOE8I1]
```{r}

tbl_panel %>% 
  count(CC10_330A) 
```

See head of dataset in in console
```{r}

head(tbl_panel)
```

View 1st 6 rows of data for all vars as dataset
```{r, eval=FALSE}

head(tbl_panel) %>% View
```

NOTE: Discrepancies between pdf "guide" and data:
(1) "Guide" says roll call votes 2010 should all have preface CC10_332 - but in data all have preface CC10_330. 
(2) Data says CC10_330H = Stem cell & CC10_330I = Foreign Intelligence Surveillance Act // Guide swaps them.

Recode CC10_330A as factor - converts the labeled numeric column into a factor with strings as the values.

```{r}

tbl_panel <- tbl_panel %>% 
    mutate(CC10_330A_fac = as_factor(CC10_330A))

# check successful mutate
tbl_panel %>% 
  count(CC10_330A, CC10_330A_fac)
```

Count all 2010 vars noted in pdf guide to verify they're in dataset (p.49 of guide)
```{r}

CC10_330_vars <- tbl_panel %>% 
  select(CC10_330B, CC10_330C, CC10_330D, CC10_330E,
         CC10_330F, CC10_330G, CC10_330H, CC10_330I, CC10_330J) %>% 
  colnames() 

CC10_330_vars %>% 
  map(~ tbl_panel %>% count(!!sym(.x)))
```


Recode all remaining 2010 vars as factor
```{r}

tbl_panel <- tbl_panel %>% 
  mutate_at(vars(CC10_330B, CC10_330C, CC10_330D, CC10_330E,
                 CC10_330F, CC10_330G, CC10_330H, CC10_330I, CC10_330J), 
            funs(fac = as_factor(.)))
```


Confirm that mutate performed correctly
```{r}

fac_vars <- CC10_330_vars %>% 
  paste0("_fac")

map2(CC10_330_vars, fac_vars, ~ tbl_panel %>% count(!!sym(.x), !!sym(.y)))
```


2012: Count all 2012 vars noted in pdf guide to verify they're in dataset (p. 143 of guide)
```{r}

CC12_vars <- tbl_panel %>% 
  select(CC12_330A, CC12_330B, CC12_330C, CC12_330D, CC12_330E,
         CC12_330F, CC12_330G, CC12_330H, CC12_332A, CC12_332B,
         CC12_332C, CC12_332D, CC12_332E, CC12_332F) %>% 
  colnames() 

CC12_vars %>% 
  map(~ tbl_panel %>% count(!!sym(.x)))
```

JO note: the final 2 vars in the list in the guidebook don't appear in the data:
CC12_332G = Repeal ACA
CC12_332H = Keystone 


Recode all 2012 roll call votes as factors
```{r}

tbl_panel <- tbl_panel %>% 
  mutate_at(vars(CC12_330A, CC12_330B, CC12_330C, CC12_330D, CC12_330E,
                 CC12_330F, CC12_330G, CC12_330H, CC12_332A, CC12_332B,
                 CC12_332C, CC12_332D, CC12_332E, CC12_332F), 
            funs(fac = as_factor(.)))

# Confirm that mutate performed correctly
CC12_fac_vars <- CC12_vars %>% 
  paste0("_fac")

map2(CC12_vars, CC12_fac_vars, ~ tbl_panel %>% count(!!sym(.x), !!sym(.y)))
```

Count all 2014 vars noted in pdf guide to verify they're in dataset (p. 269ff of guide)
```{r}

CC14_vars <- tbl_panel %>% 
  select(CC14_330A, CC14_330B, CC14_330C, CC14_330D, CC14_330E,
         CC14_330F, CC14_330G, CC14_330H, CC14_332A, CC14_332B,
         CC14_332C, CC14_332D, CC14_332E, CC14_332F) %>% 
  colnames() 

CC14_vars %>% 
  map(~ tbl_panel %>% count(!!sym(.x)))
```



Recode all 2014 roll call votes as factors
```{r}

tbl_panel <- tbl_panel %>% 
  mutate_at(vars(CC14_330A, CC14_330B, CC14_330C, CC14_330D, CC14_330E,
                 CC14_330F, CC14_330G, CC14_330H, CC14_332A, CC14_332B,
                 CC14_332C, CC14_332D, CC14_332E, CC14_332F), 
            funs(fac = as_factor(.)))

# Confirm that mutate performed correctly
CC14_fac_vars <- CC14_vars %>% 
  paste0("_fac")

map2(CC14_vars, CC14_fac_vars, ~ tbl_panel %>% count(!!sym(.x), !!sym(.y)))
```


## Merge available coded roll call votes
NOTE: 2010 exists in CCES dataverse, but only codes Congressional candidates by race and ethnicity variables.

2012 relevant folder in github: "CCES 2012 supplemental"

## Recode Socio-Dem Data

Next step: recode socio-dem data - code below is a start
```{r}

tbl_panel %>% 
  select(gender_10, birthyr_10) %>% 
  mutate(gender = as_factor(gender_10),
         age    = 2010 - birthyr_10)
```

Following vars used in stata:
codebook V101 V103 cdid cdid113 countyfips

